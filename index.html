<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pro Wallet - Dashboard de Gastos</title>
  
  <!-- iOS Status Bar Configuration -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1e293b">
  <meta name="msapplication-navbutton-color" content="#1e293b">
  <meta name="apple-mobile-web-app-title" content="Pro Wallet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;600;700&display=swap"
    rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      min-height: 100vh;
      padding: 20px;
      color: #e2e8f0;
      /* iOS Status Bar Support */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    /* iOS Status Bar Background */
    @supports (padding: max(0px)) {
      body {
        padding-top: max(20px, env(safe-area-inset-top));
        padding-bottom: max(20px, env(safe-area-inset-bottom));
        padding-left: max(20px, env(safe-area-inset-left));
        padding-right: max(20px, env(safe-area-inset-right));
      }
    }

    /* Ensure the status bar area has the same background */
    html {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      min-height: 100vh;
      /* iOS Home Indicator Support */
      min-height: -webkit-fill-available;
    }

    /* iOS Home Indicator Background Fix */
    @supports (padding: max(0px)) {
      html {
        min-height: 100vh;
        min-height: -webkit-fill-available;
      }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      animation: fadeInUp 0.9s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* --- Header --- */
    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 4rem;
      font-weight: 800;
      margin-bottom: 15px;
      background: linear-gradient(90deg, #38bdf8, #6366f1, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.02em;
      text-shadow: 0 4px 18px rgba(0, 0, 0, 0.4);
      animation: fadeIn 1s ease-out;
    }

    .header .subtitle {
      font-size: 1.25rem;
      opacity: 0.9;
      font-weight: 500;
      margin-top: 12px;
      color: #cbd5e1;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    #connection-status {
      margin-top: 15px;
      padding: 8px 18px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 30px;
      display: inline-block;
      font-size: 0.9rem;
      color: #f1f5f9;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* --- Cards de Stats --- */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
      backdrop-filter: blur(16px);
      border-radius: 18px;
      padding: 28px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
    }

    .stat-card h3 {
      font-size: 0.9rem;
      color: #94a3b8;
      margin-bottom: 10px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #f8fafc;
      margin-bottom: 15px;
    }

    .stat-change {
      font-size: 0.9rem;
      font-weight: 500;
      color: #cbd5e1;
    }

    /* --- Tabla --- */
    .expenses-table-container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow-x: auto;
    }

    .expenses-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      min-width: 800px;
    }

    .table-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: #f1f5f9;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .refresh-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #e2e8f0;
    }

    .refresh-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .refresh-btn:active {
      transform: scale(0.95);
    }

    .refresh-btn.loading {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    .refresh-icon {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }



    .expenses-table th {
      background: #334155;
      color: #f8fafc;
      padding: 12px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      text-align: left;
      font-weight: 600;
    }

    .expenses-table td {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.9rem;
      color: #e2e8f0;
      text-align: left;
      vertical-align: middle;
    }

    .expenses-table td:nth-child(1) {
      width: 12%;
      font-weight: 500;
    }

    .expenses-table td:nth-child(2) {
      width: 25%;
      font-weight: 500;
    }

    .expenses-table td:nth-child(3) {
      width: 15%;
    }

    .expenses-table td:nth-child(4) {
      width: 20%;
      text-align: right;
      font-weight: 600;
      color: #38bdf8;
    }

    .expenses-table td:nth-child(5) {
      width: 15%;
      text-align: center;
    }

    .expenses-table td:nth-child(6) {
      width: 13%;
      text-align: center;
      color: #94a3b8;
    }

    .expenses-table th:nth-child(4) {
      text-align: right;
    }

    .expenses-table th:nth-child(5),
    .expenses-table th:nth-child(6) {
      text-align: center;
    }

    .expenses-table tr:hover td {
      background-color: rgba(255, 255, 255, 0.05);
      transition: background-color 0.2s ease;
    }

    .expenses-table tr:nth-child(even) td {
      background-color: rgba(255, 255, 255, 0.02);
    }

    .expenses-table tr:nth-child(even):hover td {
      background-color: rgba(255, 255, 255, 0.08);
    }

    /* Responsive design for mobile */
    @media (max-width: 768px) {
      .expenses-table-container {
        padding: 15px;
      }
      
      .expenses-table {
        min-width: 600px;
        font-size: 0.8rem;
      }
      
      .expenses-table th,
      .expenses-table td {
        padding: 8px 6px;
      }
    }

    /* --- Chart --- */
    .chart-container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chart-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #f8fafc;
      margin-bottom: 15px;
      text-align: center;
    }

    /* --- Footer --- */
    .footer {
      margin-top: 60px;
      padding: 25px 0;
      text-align: center;
      font-size: 0.85rem;
      color: #94a3b8;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* iOS Specific Styles */
    @media screen and (max-width: 768px) {
      body {
        /* Ensure proper spacing on iOS */
        padding-top: max(20px, env(safe-area-inset-top));
        /* Ensure bottom area matches background */
        padding-bottom: max(20px, env(safe-area-inset-bottom));
      }
      
      .container {
        /* Add extra top margin for iOS status bar */
        margin-top: env(safe-area-inset-top);
      }

      .footer {
        /* Ensure footer respects bottom safe area */
        margin-bottom: env(safe-area-inset-bottom);
      }
    }

    /* Prevent iOS Safari from zooming on input focus */
    @media screen and (max-width: 768px) {
      input, select, textarea {
        font-size: 16px;
      }
    }

    /* iOS Safari specific fixes */
    @supports (-webkit-touch-callout: none) {
      body {
        /* iOS Safari specific background */
        background-attachment: scroll;
        /* Ensure background extends to home indicator */
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }
      
      .container {
        /* Ensure proper rendering on iOS */
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
      }

      /* iOS Home Indicator Area */
      html, body {
        /* Prevent white background in home indicator area */
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        background-attachment: fixed;
      }
    }

    /* Additional iOS Home Indicator Support */
    @media screen and (max-width: 768px) {
      /* Ensure the gradient extends to the very bottom */
      body::after {
        content: '';
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: env(safe-area-inset-bottom);
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        z-index: -1;
        pointer-events: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>PRO WALLET</h1>
      <p class="subtitle">Tu dashboard profesional de gastos personales</p>
      <div id="connection-status">
        <span id="status-text">Conectando a Google Sheets...</span>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h3>Gasto Total</h3>
        <div class="stat-value" id="total-expenses" data-value="0">$0</div>
        <div class="stat-change" id="total-change">Calculando...</div>
      </div>
      <div class="stat-card">
        <h3>Gasto del Mes</h3>
        <div class="stat-value" id="month-expenses" data-value="0">$0</div>
        <div class="stat-change" id="month-change">Calculando...</div>
      </div>
      <div class="stat-card">
        <h3>Promedio Diario</h3>
        <div class="stat-value" id="daily-average" data-value="0">$0</div>
        <div class="stat-change" id="daily-change">Este mes</div>
      </div>
    </div>

    <div class="main-content">
      <div class="expenses-table-container">
        <h2 class="table-title">
          Últimos Gastos
          <button class="refresh-btn" id="refresh-btn" title="Recargar datos">
            <svg class="refresh-icon" viewBox="0 0 24 24">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
          </button>
        </h2>
        <table class="expenses-table" id="expenses-table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Producto</th>
              <th>Categoría</th>
              <th>Precio (Gs)</th>
              <th>Forma de Pago</th>
              <th>Hora</th>
            </tr>
          </thead>
          <tbody id="expenses-tbody">
          </tbody>
        </table>
      </div>
<br>
      <div class="chart-container">
        <h3 class="chart-title">Gastos por Categoría</h3>
        <div class="chart" id="category-chart"></div>
      </div>
    </div>
  </div>

  <footer class="footer">
    © 2025 Desarrollado por KEV
  </footer>

  <script>
    // Configuración de Google Sheets
    const GOOGLE_SHEETS_CONFIG = {
        SHEET_ID: '1-71MXkppgdH3q-F8t6TnKK4V18s_AHqlMIzxG3mfWLg',
        SHEET_NAME: 'Sheet1'
    };

    // Estado global
    let expensesData = [];
    let connectionStatus = 'connecting';

    // Elementos del DOM
    const elements = {
        statusText: document.getElementById('status-text'),
        totalExpenses: document.getElementById('total-expenses'),
        monthExpenses: document.getElementById('month-expenses'),
        dailyAverage: document.getElementById('daily-average'),
        totalChange: document.getElementById('total-change'),
        monthChange: document.getElementById('month-change'),
        dailyChange: document.getElementById('daily-change'),
        expensesTbody: document.getElementById('expenses-tbody'),
        categoryChart: document.getElementById('category-chart'),
        refreshBtn: document.getElementById('refresh-btn')
    };

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        initializeDashboard();
        setupEventListeners();
    });

    // Configurar event listeners
    function setupEventListeners() {
        elements.refreshBtn.addEventListener('click', handleRefresh);
    }

    // Manejar click del botón de refresh
    async function handleRefresh() {
        if (elements.refreshBtn.classList.contains('loading')) {
            return; // Evitar múltiples clicks mientras está cargando
        }

        // Agregar clase de loading
        elements.refreshBtn.classList.add('loading');
        
        try {
            // Actualizar estado de conexión
            updateConnectionStatus('Recargando datos...', 'connecting');
            
            // Recargar datos
            await loadDataFromGoogleSheets();
            
            // Mostrar mensaje de éxito temporal
            updateConnectionStatus('Datos actualizados', 'connected');
            
            // Ocultar mensaje después de 2 segundos
            setTimeout(() => {
                if (connectionStatus === 'connected') {
                    updateConnectionStatus('Conectado a Google Sheets', 'connected');
                }
            }, 2000);
            
        } catch (error) {
            console.error('Error al recargar:', error);
            updateConnectionStatus('Error al recargar: ' + error.message, 'error');
        } finally {
            // Remover clase de loading
            elements.refreshBtn.classList.remove('loading');
        }
    }

    // Inicializar dashboard
    async function initializeDashboard() {
        try {
            updateConnectionStatus('Conectando a Google Sheets...', 'connecting');
            await loadDataFromGoogleSheets();
        } catch (error) {
            console.error('Error al inicializar:', error);
            updateConnectionStatus('Error de conexión', 'error');
        }
    }

    // Cargar datos desde Google Sheets
    async function loadDataFromGoogleSheets() {
        try {
            // URLs para intentar acceder a Google Sheets
            const urls = [
                `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEETS_CONFIG.SHEET_ID}/pub?gid=0&single=true&output=csv`,
                `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEETS_CONFIG.SHEET_ID}/export?gid=0&format=csv`
            ];

            let csvData = null;
            let lastError = null;

            // Intentar cada URL
            for (const url of urls) {
                try {
                    console.log('Intentando URL:', url);
                    const response = await fetch(url);
                    
                    if (response.ok) {
                        csvData = await response.text();
                        console.log('Datos CSV obtenidos exitosamente');
                        break;
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.warn('Error con URL:', url, error);
                    lastError = error;
                    continue;
                }
            }

            if (!csvData) {
                throw new Error('No se pudo acceder a Google Sheets. Verifica que esté publicado.');
            }

            // Parsear CSV
            expensesData = parseCSV(csvData);
            
            if (expensesData.length === 0) {
                throw new Error('No se encontraron datos en la hoja');
            }

            console.log('Datos cargados:', expensesData.length, 'filas');
            
            // Actualizar UI
            updateDashboard();
            updateConnectionStatus('Conectado a Google Sheets', 'connected');

        } catch (error) {
            console.error('Error al cargar datos:', error);
            updateConnectionStatus('Error: ' + error.message, 'error');
            
            // Mostrar datos de ejemplo si hay error
            showSampleData();
        }
    }

    // Parsear CSV a array de objetos
    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        if (lines.length < 2) return [];

        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        const data = [];

        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
            
            // Solo procesar filas con datos válidos
            if (values.length > 0 && values.slice(0, 3).some(v => v !== '')) {
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
        }

        return data;
    }

    // Actualizar dashboard con datos reales
    function updateDashboard() {
        updateStats();
        updateExpensesTable();
        updateCategoryChart();
    }

    // Actualizar estadísticas
    function updateStats() {
        const totalExpenses = expensesData.reduce((sum, row) => {
            const precio = parseInt(row['Precio-Gs'] || '0') || 0;
            return sum + precio;
        }, 0);

        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        
        const monthExpenses = expensesData.reduce((sum, row) => {
            const fecha = row['Fecha'];
            if (fecha) {
                const date = parseDate(fecha);
                if (date && date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                    const precio = parseInt(row['Precio-Gs'] || '0') || 0;
                    return sum + precio;
                }
            }
            return sum;
        }, 0);

        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const dailyAverage = Math.round(monthExpenses / daysInMonth);

        // Animar valores
        animateValue('total-expenses', 0, totalExpenses, 1000);
        animateValue('month-expenses', 0, monthExpenses, 1000);
        animateValue('daily-average', 0, dailyAverage, 1000);

        // Actualizar textos de cambio
        elements.totalChange.textContent = `${expensesData.length} transacciones`;
        elements.monthChange.textContent = 'Este mes';
        elements.dailyChange.textContent = 'Promedio diario';
    }

    // Actualizar tabla de gastos
    function updateExpensesTable() {
        // Tomar los últimos 10 gastos
        const recentExpenses = expensesData
            .filter(row => row['Producto'] && row['Precio-Gs'])
            .slice(-10)
            .reverse();

        if (recentExpenses.length === 0) {
            elements.expensesTbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8; font-style: italic;">
                        No hay gastos registrados
                    </td>
                </tr>
            `;
            return;
        }

        const tableHTML = recentExpenses.map(row => {
            const categoria = row['Categoria'] || 'General';
            const formaPago = row['forma de pago'] || 'N/A';
            const hora = row['Hora'] || 'N/A';
            
            // Aplicar estilos especiales según la forma de pago
            let formaPagoClass = '';
            if (formaPago.toLowerCase().includes('crédito')) {
                formaPagoClass = 'style="color: #f59e0b; font-weight: 500;"';
            } else if (formaPago.toLowerCase().includes('débito')) {
                formaPagoClass = 'style="color: #10b981; font-weight: 500;"';
            } else if (formaPago.toLowerCase().includes('efectivo')) {
                formaPagoClass = 'style="color: #6366f1; font-weight: 500;"';
            }

            return `
                <tr>
                    <td>${formatDate(row['Fecha'])}</td>
                    <td>${escapeHtml(row['Producto'])}</td>
                    <td>${escapeHtml(categoria)}</td>
                    <td>${formatPrice(row['Precio-Gs'])}</td>
                    <td ${formaPagoClass}>${escapeHtml(formaPago)}</td>
                    <td>${escapeHtml(hora)}</td>
                </tr>
            `;
        }).join('');

        elements.expensesTbody.innerHTML = tableHTML;
    }

    // Actualizar gráfico de categorías
    function updateCategoryChart() {
        const categoryData = {};
        
        expensesData.forEach(row => {
            const categoria = row['Categoria'] || 'General';
            const precio = parseInt(row['Precio-Gs'] || '0') || 0;
            
            categoryData[categoria] = (categoryData[categoria] || 0) + precio;
        });

        // Crear gráfico simple con HTML/CSS
        const chartHTML = Object.entries(categoryData)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5)
            .map(([category, amount]) => {
                const percentage = (amount / Object.values(categoryData).reduce((a, b) => a + b, 0)) * 100;
                return `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 0.9rem;">${escapeHtml(category)}</span>
                            <span style="font-size: 0.9rem; color: #38bdf8;">${formatPrice(amount.toString())}</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #38bdf8, #6366f1); height: 100%; width: ${percentage}%; transition: width 0.8s ease;"></div>
                        </div>
                    </div>
                `;
            }).join('');

        elements.categoryChart.innerHTML = chartHTML;
    }

    // Mostrar datos de ejemplo si hay error
    function showSampleData() {
        const sampleData = [
            { 'Producto': 'Galletita', 'Fecha': '2024-12-19', 'Precio-Gs': '8000', 'forma de pago': 'CRÉDITO', 'Hora': '14:30', 'Categoria': 'Alimentos' },
            { 'Producto': 'Netflix', 'Fecha': '2024-12-19', 'Precio-Gs': '75000', 'forma de pago': 'EFECTIVO', 'Hora': '15:30', 'Categoria': 'Suscripción' },
            { 'Producto': 'Pizza', 'Fecha': '2024-12-19', 'Precio-Gs': '47500', 'forma de pago': 'EFECTIVO', 'Hora': '14:30', 'Categoria': 'Alimentos' }
        ];

        expensesData = sampleData;
        updateDashboard();
    }

    // Actualizar estado de conexión
    function updateConnectionStatus(message, status) {
        connectionStatus = status;
        elements.statusText.textContent = message;
        
        const statusElement = document.getElementById('connection-status');
        statusElement.className = '';
        
        switch (status) {
            case 'connected':
                statusElement.style.background = 'rgba(34, 197, 94, 0.1)';
                statusElement.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                statusElement.style.color = '#22c55e';
                break;
            case 'error':
                statusElement.style.background = 'rgba(239, 68, 68, 0.1)';
                statusElement.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                statusElement.style.color = '#ef4444';
                break;
            case 'connecting':
            default:
                statusElement.style.background = 'rgba(59, 130, 246, 0.1)';
                statusElement.style.borderColor = 'rgba(59, 130, 246, 0.3)';
                statusElement.style.color = '#3b82f6';
                break;
        }
    }

    // Utilidades
    function parseDate(dateString) {
        // Intentar diferentes formatos de fecha
        const formats = [
            /(\d{1,2})\/(\d{1,2})\/(\d{4})/, // DD/MM/YYYY
            /(\d{4})-(\d{1,2})-(\d{1,2})/,   // YYYY-MM-DD
        ];

        for (const format of formats) {
            const match = dateString.match(format);
            if (match) {
                if (format.source.includes('YYYY')) {
                    return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
                } else {
                    return new Date(parseInt(match[3]), parseInt(match[2]) - 1, parseInt(match[1]));
                }
            }
        }
        return null;
    }

    function formatDate(dateString) {
        const date = parseDate(dateString);
        if (!date) return dateString;
        
        return date.toLocaleDateString('es-PY', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }

    function formatPrice(price) {
        const numPrice = parseInt(price) || 0;
        return new Intl.NumberFormat('es-PY', {
            style: 'currency',
            currency: 'PYG',
            minimumFractionDigits: 0
        }).format(numPrice);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // --- Animación de conteo ---
    function animateValue(id, start, end, duration) {
      const element = document.getElementById(id);
      let startTimestamp = null;
      const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        const value = Math.floor(progress * (end - start) + start);
        element.textContent = "₲" + new Intl.NumberFormat('es-PY').format(value);
        if (progress < 1) {
          window.requestAnimationFrame(step);
        }
      };
      window.requestAnimationFrame(step);
    }

    // Refrescar datos automáticamente cada 5 minutos
    setInterval(() => {
        if (!document.hidden && connectionStatus === 'connected') {
            loadDataFromGoogleSheets();
        }
    }, 5 * 60 * 1000);

    // Manejar cambios de visibilidad de la página
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && connectionStatus !== 'connected') {
            initializeDashboard();
        }
    });
  </script>
</body>
</html>
