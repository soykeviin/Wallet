<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Wallet - Dashboard de Gastos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Inter', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 4rem;
            font-weight: 800;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #e2e8f0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 8px 32px rgba(0,0,0,0.3);
            letter-spacing: -0.03em;
            line-height: 1;
            position: relative;
        }

        .header h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        .header .subtitle {
            font-size: 1.375rem;
            opacity: 0.95;
            font-weight: 500;
            letter-spacing: 0.02em;
            line-height: 1.5;
            margin-top: 20px;
        }

        .footer {
            margin-top: 60px;
            padding: 30px 0;
            text-align: center;
            color: rgba(255,255,255,0.8);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .footer-left {
            text-align: left;
        }

        .footer-right {
            text-align: right;
        }

        .footer-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }

        .footer-subtitle {
            font-size: 0.875rem;
            font-weight: 400;
            opacity: 0.8;
            letter-spacing: 0.01em;
        }

        .footer-year {
            font-size: 0.875rem;
            font-weight: 500;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .footer-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .footer-left,
            .footer-right {
                text-align: center;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.8);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0,0,0,0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .stat-card h3 {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
            line-height: 1.2;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            letter-spacing: -0.02em;
            line-height: 1.1;
        }

        .stat-change {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.01em;
            line-height: 1.3;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        .stat-change .arrow {
            margin-right: 5px;
            font-size: 1.2rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }

        .expenses-table-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .table-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            letter-spacing: -0.01em;
            line-height: 1.3;
        }

        .table-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.4);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        .refresh-btn.loading svg {
            animation: spin 1s linear infinite;
        }

        .search-box {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 400;
            letter-spacing: 0.01em;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .expenses-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .expenses-table th {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            line-height: 1.2;
        }

        .expenses-table th:first-child {
            border-radius: 10px 0 0 10px;
        }

        .expenses-table th:last-child {
            border-radius: 0 10px 10px 0;
        }

        .expenses-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
            font-weight: 400;
            letter-spacing: 0.01em;
            line-height: 1.4;
            transition: all 0.3s ease;
        }

        .expenses-table tr:hover td {
            background-color: #f8fafc;
        }

        .category-tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            line-height: 1.2;
        }

        .category-alimentacion { background: #fef3c7; color: #92400e; }
        .category-transporte { background: #dbeafe; color: #1e40af; }
        .category-entretenimiento { background: #fce7f3; color: #be185d; }
        .category-servicios { background: #d1fae5; color: #065f46; }
        .category-compras { background: #e0e7ff; color: #3730a3; }
        .category-otros { background: #f3f4f6; color: #374151; }

        .amount {
            font-weight: 600;
            color: #ef4444;
            letter-spacing: -0.01em;
        }

        .chart-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 25px;
            text-align: center;
            letter-spacing: -0.01em;
            line-height: 1.3;
        }

        .chart {
            height: 300px;
            display: flex;
            align-items: end;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 20px 0;
        }

        .chart-bar {
            width: 40px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 5px 5px 0 0;
            position: relative;
            transition: all 0.3s ease;
            animation: slideUp 1s ease-out;
        }

        .chart-bar:hover {
            transform: scale(1.05);
        }

        @keyframes slideUp {
            from {
                height: 0 !important;
            }
        }

        .chart-bar::before {
            content: attr(data-value);
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: #333;
            letter-spacing: -0.01em;
        }

        .chart-label {
            text-align: center;
            margin-top: 10px;
            font-size: 0.75rem;
            color: #666;
            font-weight: 500;
            letter-spacing: 0.01em;
            line-height: 1.2;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 3rem;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .expenses-table {
                font-size: 0.75rem;
            }
            
            .expenses-table th,
            .expenses-table td {
                padding: 10px 8px;
            }
            
            .header h1 {
                font-size: 2.5rem;
                letter-spacing: -0.02em;
            }
            
            .header .subtitle {
                font-size: 1.125rem;
            }
        }
    </style>
</head>
<body>
    <br>
    <div class="container">
        <div class="header">
            <h1>PRO WALLET </h1>
            <p class="subtitle">Tu dashboard profesional de gastos personales</p>
            <div id="connection-status" style="margin-top: 10px; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 20px; display: inline-block; font-size: 0.9rem;">
                <span id="status-text">Conectando a Google Sheets...</span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Gasto Total</h3>
                <div class="stat-value" id="total-expenses">$0</div>
                <div class="stat-change" id="total-change">
                    <span class="arrow">â†’</span>
                    Calculando...
                </div>
            </div>
            <div class="stat-card">
                <h3>Gasto del Mes</h3>
                <div class="stat-value" id="month-expenses">$0</div>
                <div class="stat-change" id="month-change">
                    <span class="arrow">â†’</span>
                    Calculando...
                </div>
            </div>
            <div class="stat-card">
                <h3>Promedio Diario</h3>
                <div class="stat-value" id="daily-average">$0</div>
                <div class="stat-change" id="daily-change">
                    <span class="arrow">â†’</span>
                    Este mes
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="expenses-table-container">
                <div class="table-header">
                    <h2 class="table-title">Ãšltimos Gastos</h2>
                    <div class="table-controls">
                        <button class="refresh-btn" id="refresh-btn" title="Actualizar datos">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                                <path d="M21 3v5h-5"/>
                                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                                <path d="M3 21v-5h5"/>
                            </svg>
                        </button>
                        <input type="text" class="search-box" id="search-input" placeholder="Buscar gastos...">
                    </div>
                </div>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                </div>
                <table class="expenses-table" id="expenses-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Producto</th>
                            <th>CategorÃ­a</th>
                            <th>Precio (Gs)</th>
                            <th>Forma de Pago</th>
                            <th>Hora</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-tbody">
                    </tbody>
                </table>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">Gastos por CategorÃ­a</h3>
                <div class="chart" id="category-chart">
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-left">
                <div class="footer-title">Pro Wallet</div>
                <div class="footer-subtitle">Dashboard profesional de gastos personales</div>
            </div>
            <div class="footer-right">
                <div class="footer-year">Â© 2025 Desarrollado por KEV</div>
            </div>
        </div>
    </footer>

    <script>
        // ConfiguraciÃ³n de Google Sheets
        const GOOGLE_SHEET_ID = '1-71MXkppgdH3q-F8t6TnKK4V18s_AHqlMIzxG3mfWLg';
        const GOOGLE_SHEET_NAME = 'Sheet1';
        
        // Datos de ejemplo en GuaranÃ­es (fallback si no se puede conectar a Google Sheets)
        const sampleData = [
            { fecha: '2024-08-20', descripcion: 'Supermercado Stock', categoria: 'AlimentaciÃ³n', monto: 285000 },
            { fecha: '2024-08-19', descripcion: 'Uber', categoria: 'Transporte', monto: 45000 },
            { fecha: '2024-08-18', descripcion: 'Netflix', categoria: 'Entretenimiento', monto: 89000 },
            { fecha: '2024-08-17', descripcion: 'ANDE - Electricidad', categoria: 'Servicios', monto: 320000 },
            { fecha: '2024-08-16', descripcion: 'Restaurante El Bolsi', categoria: 'AlimentaciÃ³n', monto: 125000 },
            { fecha: '2024-08-15', descripcion: 'Combustible Copetrol', categoria: 'Transporte', monto: 180000 },
            { fecha: '2024-08-14', descripcion: 'MercadoLibre', categoria: 'Compras', monto: 350000 },
            { fecha: '2024-08-13', descripcion: 'CafÃ© Martinez', categoria: 'AlimentaciÃ³n', monto: 25000 },
            { fecha: '2024-08-12', descripcion: 'Cine Showcase', categoria: 'Entretenimiento', monto: 65000 },
            { fecha: '2024-08-11', descripcion: 'Farmacia Catedral', categoria: 'Otros', monto: 95000 },
            { fecha: '2024-08-10', descripcion: 'Tigo Money', categoria: 'Servicios', monto: 15000 },
            { fecha: '2024-08-09', descripcion: 'Real Supermercado', categoria: 'AlimentaciÃ³n', monto: 225000 },
            { fecha: '2024-07-28', descripcion: 'Gasolina Shell', categoria: 'Transporte', monto: 175000 },
            { fecha: '2024-07-25', descripcion: 'Personal Internet', categoria: 'Servicios', monto: 155000 },
            { fecha: '2024-07-20', descripcion: 'PizzerÃ­a Don Vito', categoria: 'AlimentaciÃ³n', monto: 185000 },
            { fecha: '2024-07-18', descripcion: 'Shopping del Sol', categoria: 'Compras', monto: 425000 },
            { fecha: '2024-07-15', descripcion: 'Agua ESSAP', categoria: 'Servicios', monto: 85000 },
            { fecha: '2024-07-12', descripcion: 'Uber Eats', categoria: 'AlimentaciÃ³n', monto: 75000 },
            { fecha: '2024-07-10', descripcion: 'Claro TV', categoria: 'Servicios', monto: 125000 },
            { fecha: '2024-07-08', descripcion: 'Farmacia San Roque', categoria: 'Otros', monto: 55000 }
        ];

        class ProWallet {
            constructor() {
                this.data = [];
                this.filteredData = [];
                this.init();
            }

            async init() {
                try {
                    // Simular carga de datos
                    await this.loadData();
                    this.renderStats();
                    this.renderTable();
                    this.renderChart();
                    this.setupEventListeners();
                } catch (error) {
                    console.error('Error initializing Pro Wallet:', error);
                }
            }

            async loadData() {
                try {
                    // Actualizar estado de conexiÃ³n
                    this.updateConnectionStatus('Conectando a Google Sheets...', 'connecting');
                    
                    // Intentar cargar datos desde Google Sheets
                    const sheetData = await this.fetchGoogleSheetsData();
                    
                    if (sheetData && sheetData.length > 0) {
                        this.data = sheetData.map(item => ({
                            ...item,
                            fecha: new Date(item.fecha),
                            monto: parseFloat(item.monto)
                        })).sort((a, b) => b.fecha - a.fecha);
                        
                        console.log('Datos cargados desde Google Sheets:', this.data.length, 'registros');
                        this.updateConnectionStatus(`âœ… Conectado a Google Sheets (${this.data.length} registros)`, 'connected');
                    } else {
                        // Fallback a datos de ejemplo
                        this.data = sampleData.map(item => ({
                            ...item,
                            fecha: new Date(item.fecha),
                            monto: parseFloat(item.monto)
                        })).sort((a, b) => b.fecha - a.fecha);
                        
                        console.log('Usando datos de ejemplo (fallback)');
                        this.updateConnectionStatus('âš ï¸ Usando datos de ejemplo (Sheet vacÃ­o)', 'warning');
                    }
                    
                    this.filteredData = [...this.data];
                    
                    // Ocultar loading
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('expenses-table').style.display = 'table';
                    
                } catch (error) {
                    console.error('Error cargando datos:', error);
                    
                    // Fallback a datos de ejemplo en caso de error
                    this.data = sampleData.map(item => ({
                        ...item,
                        fecha: new Date(item.fecha),
                        monto: parseFloat(item.monto)
                    })).sort((a, b) => b.fecha - a.fecha);
                    
                    this.filteredData = [...this.data];
                    
                    // Ocultar loading
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('expenses-table').style.display = 'table';
                    
                    this.updateConnectionStatus('âŒ Error de conexiÃ³n - Usando datos de ejemplo', 'error');
                    this.showNotification('Error al cargar datos de Google Sheets. Usando datos de ejemplo.', 'error');
                }
            }

            renderStats() {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;

                // Calcular gastos totales
                const totalExpenses = this.data.reduce((sum, item) => sum + item.monto, 0);
                
                // Calcular gastos del mes actual
                const currentMonthExpenses = this.data
                    .filter(item => item.fecha.getMonth() === currentMonth && item.fecha.getFullYear() === currentYear)
                    .reduce((sum, item) => sum + item.monto, 0);
                
                // Calcular gastos del mes pasado
                const lastMonthExpenses = this.data
                    .filter(item => item.fecha.getMonth() === lastMonth && item.fecha.getFullYear() === lastMonthYear)
                    .reduce((sum, item) => sum + item.monto, 0);

                // Calcular cambio porcentual
                const monthChange = lastMonthExpenses > 0 
                    ? ((currentMonthExpenses - lastMonthExpenses) / lastMonthExpenses * 100).toFixed(1)
                    : 0;

                // Calcular promedio diario
                const currentMonthDays = new Date(currentYear, currentMonth + 1, 0).getDate();
                const daysPassed = now.getDate();
                const dailyAverage = daysPassed > 0 ? (currentMonthExpenses / daysPassed).toFixed(2) : 0;

                // Actualizar UI con formato de GuaranÃ­es
                document.getElementById('total-expenses').textContent = `â‚²${this.formatGuaranies(totalExpenses)}`;
                document.getElementById('month-expenses').textContent = `â‚²${this.formatGuaranies(currentMonthExpenses)}`;
                document.getElementById('daily-average').textContent = `â‚²${this.formatGuaranies(dailyAverage)}`;

                // Actualizar cambios
                const totalChangeEl = document.getElementById('total-change');
                totalChangeEl.innerHTML = `<span class="arrow">ðŸ’°</span>Todos los gastos`;

                const monthChangeEl = document.getElementById('month-change');
                const isPositive = monthChange >= 0;
                monthChangeEl.className = `stat-change ${isPositive ? 'negative' : 'positive'}`;
                monthChangeEl.innerHTML = `
                    <span class="arrow">${isPositive ? 'ðŸ“ˆ' : 'ðŸ“‰'}</span>
                    ${isPositive ? '+' : ''}${monthChange}% vs mes pasado
                `;

                const dailyChangeEl = document.getElementById('daily-change');
                dailyChangeEl.innerHTML = `<span class="arrow">ðŸ“Š</span>Ãšltimos ${daysPassed} dÃ­as`;
            }

            formatGuaranies(amount) {
                return new Intl.NumberFormat('es-PY', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
            }

            async refreshData() {
                const refreshBtn = document.getElementById('refresh-btn');
                refreshBtn.classList.add('loading');
                refreshBtn.disabled = true;

                try {
                    // Recargar datos desde Google Sheets
                    await this.loadData();
                    this.renderStats();
                    this.renderTable();
                    this.renderChart();
                    
                    // Mostrar notificaciÃ³n de Ã©xito
                    this.showNotification('Datos actualizados correctamente desde Google Sheets', 'success');
                } catch (error) {
                    console.error('Error actualizando datos:', error);
                    this.showNotification('Error al actualizar los datos', 'error');
                } finally {
                    refreshBtn.classList.remove('loading');
                    refreshBtn.disabled = false;
                }
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                    z-index: 1000;
                    animation: slideInRight 0.3s ease-out;
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            renderTable() {
                const tbody = document.getElementById('expenses-tbody');
                tbody.innerHTML = '';

                this.filteredData.slice(0, 20).forEach(expense => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${expense.fecha.toLocaleDateString('es-PY')}</td>
                        <td>${expense.producto || expense.descripcion || 'N/A'}</td>
                        <td><span class="category-tag category-${(expense.categoria || 'otros').toLowerCase().replace('Ã³', 'o').replace('Ã­', 'i').replace(' ', '-')}">${expense.categoria || 'Sin categorÃ­a'}</span></td>
                        <td class="amount">â‚²${this.formatGuaranies(expense.monto)}</td>
                        <td>${expense.formaPago || 'N/A'}</td>
                        <td>${expense.hora || 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            renderChart() {
                const categoryTotals = {};
                this.data.forEach(expense => {
                    categoryTotals[expense.categoria] = (categoryTotals[expense.categoria] || 0) + expense.monto;
                });

                const sortedCategories = Object.entries(categoryTotals)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 6);

                const maxValue = Math.max(...sortedCategories.map(cat => cat[1]));
                const chartContainer = document.getElementById('category-chart');
                chartContainer.innerHTML = '';

                sortedCategories.forEach(([category, amount]) => {
                    const barContainer = document.createElement('div');
                    barContainer.style.display = 'flex';
                    barContainer.style.flexDirection = 'column';
                    barContainer.style.alignItems = 'center';

                    const height = Math.max((amount / maxValue) * 250, 20);
                    const bar = document.createElement('div');
                    bar.className = 'chart-bar';
                    bar.style.height = `${height}px`;
                    bar.setAttribute('data-value', `â‚²${this.formatGuaranies(amount)}`);

                    const label = document.createElement('div');
                    label.className = 'chart-label';
                    label.textContent = category.substring(0, 8) + (category.length > 8 ? '...' : '');

                    barContainer.appendChild(bar);
                    barContainer.appendChild(label);
                    chartContainer.appendChild(barContainer);
                });
            }

            setupEventListeners() {
                const searchInput = document.getElementById('search-input');
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    this.filteredData = this.data.filter(expense => 
                        (expense.producto || expense.descripcion || '').toLowerCase().includes(searchTerm) ||
                        (expense.categoria || '').toLowerCase().includes(searchTerm) ||
                        (expense.formaPago || '').toLowerCase().includes(searchTerm)
                    );
                    this.renderTable();
                });

                // Event listener para el botÃ³n de actualizar
                const refreshBtn = document.getElementById('refresh-btn');
                refreshBtn.addEventListener('click', () => {
                    this.refreshData();
                });
            }

            async fetchGoogleSheetsData() {
                try {
                    // Usar Google Sheets API v4 con CORS proxy para evitar problemas de CORS
                    const url = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${GOOGLE_SHEET_NAME}`;
                    
                    console.log('Intentando cargar datos desde:', url);
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const csvText = await response.text();
                    console.log('CSV recibido:', csvText.substring(0, 200) + '...');
                    
                    // Parsear CSV
                    const rows = this.parseCSV(csvText);
                    
                    if (rows.length < 2) {
                        throw new Error('No hay suficientes datos en el sheet');
                    }
                    
                    // La primera fila son los headers
                    const headers = rows[0];
                    console.log('Headers encontrados:', headers);
                    
                    // Procesar las filas de datos
                    const expenses = rows.slice(1)
                        .filter(row => row.length > 0 && row[0] && row[0].trim() !== '') // Filtrar filas vacÃ­as
                        .map(row => {
                            const expense = {};
                            headers.forEach((header, index) => {
                                expense[header.trim()] = row[index] ? row[index].trim() : '';
                            });
                            
                            // Mapear los campos del sheet a nuestro formato
                            return {
                                fecha: expense['Fecha'] || expense['fecha'],
                                producto: expense['Producto'] || expense['producto'],
                                monto: this.parseAmount(expense['Precio-Gs'] || expense['precio-gs'] || expense['Precio'] || expense['precio']),
                                categoria: expense['Categoria'] || expense['categoria'] || 'Sin categorÃ­a',
                                formaPago: expense['forma de pago'] || expense['Forma de pago'] || expense['Forma de Pago'],
                                hora: expense['Hora'] || expense['hora']
                            };
                        })
                        .filter(expense => expense.fecha && expense.producto && expense.monto > 0); // Filtrar registros vÃ¡lidos
                    
                    console.log('Datos procesados:', expenses.length, 'registros vÃ¡lidos');
                    return expenses;
                    
                } catch (error) {
                    console.error('Error fetching Google Sheets data:', error);
                    throw error;
                }
            }

            parseCSV(csvText) {
                const lines = csvText.split('\n');
                return lines.map(line => {
                    // Manejar comillas y comas dentro de campos
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    
                    result.push(current.trim());
                    return result;
                });
            }

            parseAmount(amountStr) {
                if (!amountStr) return 0;
                
                // Remover caracteres no numÃ©ricos excepto punto y coma
                const cleanStr = amountStr.toString().replace(/[^\d.,]/g, '');
                
                // Manejar diferentes formatos de nÃºmeros
                if (cleanStr.includes(',')) {
                    // Formato con comas como separadores de miles
                    return parseFloat(cleanStr.replace(/,/g, ''));
                } else {
                    return parseFloat(cleanStr) || 0;
                }
            }

            updateConnectionStatus(message, status) {
                const statusElement = document.getElementById('status-text');
                const statusContainer = document.getElementById('connection-status');
                
                if (statusElement && statusContainer) {
                    statusElement.textContent = message;
                    
                    // Actualizar colores segÃºn el estado
                    switch (status) {
                        case 'connected':
                            statusContainer.style.background = 'rgba(16, 185, 129, 0.2)';
                            statusContainer.style.border = '1px solid rgba(16, 185, 129, 0.5)';
                            break;
                        case 'warning':
                            statusContainer.style.background = 'rgba(245, 158, 11, 0.2)';
                            statusContainer.style.border = '1px solid rgba(245, 158, 11, 0.5)';
                            break;
                        case 'error':
                            statusContainer.style.background = 'rgba(239, 68, 68, 0.2)';
                            statusContainer.style.border = '1px solid rgba(239, 68, 68, 0.5)';
                            break;
                        case 'connecting':
                        default:
                            statusContainer.style.background = 'rgba(59, 130, 246, 0.2)';
                            statusContainer.style.border = '1px solid rgba(59, 130, 246, 0.5)';
                            break;
                    }
                }
            }
        }

        // Inicializar la aplicaciÃ³n cuando se carga la pÃ¡gina
        document.addEventListener('DOMContentLoaded', () => {
            new ProWallet();
        });



        // Agregar estilos para las animaciones de notificaciÃ³n
        const notificationStyles = document.createElement('style');
        notificationStyles.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(notificationStyles);
    </script>
</body>
</html>
